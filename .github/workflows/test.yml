# =============================================================================
# CI for setup-leo-action
# =============================================================================
#
# Tests the action itself to ensure it works correctly.
# Run on:
# - Push to main (test + save cache)
# - Pull requests (test only)
# - Weekly schedule (keep caches fresh)
#
# =============================================================================

name: Test Action

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 6 * * 1'  # Weekly Monday 6 AM UTC
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  LEO_VERSION: "3.4.0"  # Version to test with

jobs:
  # ===========================================================================
  # Test on Linux
  # ===========================================================================
  test-linux:
    name: Test (Linux)
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Test action
        id: setup-leo
        uses: ./
        with:
          version: ${{ env.LEO_VERSION }}
          cache-save: ${{ github.event_name == 'pull_request' && 'never' || 'always' }}
          run-audit: 'true'
      
      - name: Verify outputs
        env:
          LEO_VER: ${{ steps.setup-leo.outputs.leo-version }}
          CACHE_HIT_BINARY: ${{ steps.setup-leo.outputs.cache-hit-binary }}
          CACHE_HIT_CARGO: ${{ steps.setup-leo.outputs.cache-hit-cargo }}
          BUILD_TIME: ${{ steps.setup-leo.outputs.build-time-seconds }}
        run: |
          echo "Version: ${LEO_VER}"
          echo "Binary cache hit: ${CACHE_HIT_BINARY}"
          echo "Cargo cache hit: ${CACHE_HIT_CARGO}"
          echo "Build time: ${BUILD_TIME}s"
      
      - name: Verify Leo works
        run: |
          leo --version
          leo --help
      
      - name: Test with sample project
        run: |
          mkdir -p test-project
          cd test-project
          leo new hello_world
          cd hello_world
          leo build

  # ===========================================================================
  # Test on macOS ARM64
  # ===========================================================================
  test-macos-arm:
    name: Test (macOS ARM64)
    runs-on: macos-14
    
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Test action
        uses: ./
        with:
          version: ${{ env.LEO_VERSION }}
          cache-save: ${{ github.event_name == 'pull_request' && 'never' || 'always' }}

      - name: Verify Leo works
        run: |
          leo --version
          which leo

  # ===========================================================================
  # Test on macOS x86
  # ===========================================================================
  test-macos-x86:
    name: Test (macOS x86)
    runs-on: macos-15
    
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Test action
        uses: ./
        with:
          version: ${{ env.LEO_VERSION }}
          cache-save: ${{ github.event_name == 'pull_request' && 'never' || 'always' }}

      - name: Verify Leo works
        run: leo --version

  # ===========================================================================
  # Test cache behavior
  # ===========================================================================
  test-cache:
    name: Test Cache Behavior
    runs-on: ubuntu-24.04
    needs: [test-linux]  # Run after first test to check cache was created
    if: github.event_name != 'pull_request'  # Only on main (PRs don't save cache)
    
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Test action (should hit cache)
        id: setup-leo
        uses: ./
        with:
          version: ${{ env.LEO_VERSION }}
          cache-save: 'never'  # Don't save, just restore
      
      - name: Verify cache was hit
        env:
          CACHE_HIT_BINARY: ${{ steps.setup-leo.outputs.cache-hit-binary }}
          BUILD_TIME: ${{ steps.setup-leo.outputs.build-time-seconds }}
        run: |
          if [[ "${CACHE_HIT_BINARY}" != "true" ]]; then
            echo "::warning::Binary cache miss - expected hit after test-linux job"
          fi

          # Build time should be 0 or very low if cache hit
          echo "Build time: ${BUILD_TIME}s"

  # ===========================================================================
  # Test Leo versions with compatible Rust toolchains
  # ===========================================================================
  # Rust versions are from each release's rust-toolchain.toml:
  # https://github.com/ProvableHQ/leo/blob/<tag>/rust-toolchain.toml
  # ===========================================================================
  test-leo-versions:
    name: Test (Leo ${{ matrix.leo }} / Rust ${{ matrix.rust }})
    runs-on: ubuntu-24.04

    strategy:
      fail-fast: false
      matrix:
        include:
          # Latest release - also test with stable Rust
          - leo: "3.4.0"
            rust: "stable"
          # v3.4.0 requires Rust 1.90.0
          - leo: "3.4.0"
            rust: "1.90.0"
          # v3.3.x requires Rust 1.90.0
          - leo: "3.3.1"
            rust: "1.90.0"
          # v3.2.0 requires Rust 1.88.0
          - leo: "3.2.0"
            rust: "1.88.0"
          # v3.1.0 requires Rust 1.88.0
          - leo: "3.1.0"
            rust: "1.88.0"

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Test action with Leo ${{ matrix.leo }} / Rust ${{ matrix.rust }}
        uses: ./
        with:
          version: ${{ matrix.leo }}
          rust-version: ${{ matrix.rust }}
          cache-save: 'never'  # Don't pollute cache with multiple versions

      - name: Verify
        env:
          EXPECTED_VERSION: ${{ matrix.leo }}
        run: |
          leo --version
          # Verify version matches expected
          leo --version | grep -q "${EXPECTED_VERSION}" || echo "::warning::Version mismatch"

  # ===========================================================================
  # Lint and Security Analysis
  # ===========================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Install lint dependencies
        run: |
          # Install tools if missing (for act compatibility - GitHub runners have these)
          if ! command -v shellcheck &>/dev/null || ! python3 -c "import yaml" 2>/dev/null; then
            sudo apt-get update
            sudo apt-get install -y shellcheck python3-yaml
          fi

      - name: Lint scripts
        run: shellcheck scripts/*.sh

      - name: Validate action.yml
        run: |
          # Basic YAML validation
          python3 -c "import yaml; yaml.safe_load(open('action.yml'))"
          echo "action.yml is valid YAML"

      - name: Run zizmor security analysis
        env:
          ZIZMOR_VERSION: "1.19.0"
        run: |
          # Detect architecture
          ARCH=$(uname -m)
          case "$ARCH" in
            x86_64)  ZIZMOR_ARCH="x86_64-unknown-linux-gnu" ;;
            aarch64) ZIZMOR_ARCH="aarch64-unknown-linux-gnu" ;;
            arm64)   ZIZMOR_ARCH="aarch64-unknown-linux-gnu" ;;
            *)       echo "Unsupported architecture: $ARCH"; exit 1 ;;
          esac

          # Download and install zizmor binary
          curl -sSfL "https://github.com/zizmorcore/zizmor/releases/download/v${ZIZMOR_VERSION}/zizmor-${ZIZMOR_ARCH}.tar.gz" \
            -o zizmor.tar.gz
          tar -xzf zizmor.tar.gz
          chmod +x zizmor

          # Run with medium severity minimum
          ./zizmor --min-severity medium .github/workflows/
